name: Validate Token List JSON

on:
  pull_request:
    paths:
      - 'src/**/*.tokenlist.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate JSON Syntax
        run: |
          echo "ğŸ” VÃ©rification de la syntaxe JSON..."
          python3 -m json.tool src/cryptonia20.tokenlist.json || exit 1
          echo "âœ… Syntaxe JSON valide"

      - name: Validate Required Fields
        run: |
          echo "ğŸ” VÃ©rification des champs obligatoires..."
          python3 <<'EOF'
          import json, re, sys

          REQUIRED_ROOT = ["name", "timestamp", "version", "tokens"]
          REQUIRED_TOKEN = ["chainId", "address", "name", "symbol", "decimals"]

          try:
              with open("src/cryptonia20.tokenlist.json") as f:
                  data = json.load(f)

              # VÃ©rification des champs racines
              for field in REQUIRED_ROOT:
                  if field not in data:
                      raise ValueError(f"Champ manquant: '{field}'")

              # VÃ©rification des tokens
              if not isinstance(data["tokens"], list) or not data["tokens"]:
                  raise ValueError("'tokens' doit Ãªtre une liste non vide")

              for i, token in enumerate(data["tokens"]):
                  for field in REQUIRED_TOKEN:
                      if field not in token:
                          raise ValueError(f"Token #{i} manque le champ: '{field}'")

                  # Validation de l'adresse Ethereum
                  if not re.match(r'^0x[a-fA-F0-9]{40}$', token["address"]):
                      raise ValueError(f"Adresse Ethereum invalide: {token['address']}")

              print("âœ… Tous les champs requis sont valides")
          except Exception as e:
              print(f"âŒ Erreur: {str(e)}")
              sys.exit(1)
          EOF